# Environment Monitor

Purpose of the solution is to display measurement data (temperature, ambient light, humidity at this point) from different devices. In addition, this solution can be used for communicating to IotHub devices.

This solution includes:
 -  DB model for measurements
 -  Authentication / authorization using ASP.NET identity
 -  WebApi for fetching measurement data / communicating with devices.
 -  React UI for showing measurement data.
 -  Azure function for listening/processing measurement messages sent to Azure IoT hub.

In it's current usage, the measurement data is generated by ESP32 devices which send data to Azure IoT hub. The incoming data is processed by the Azure function that is a part of this solution.

See: https://github.com/heinonenniilo/EnvironmentMonitorArduino for ESP32 code.

## Projects

### EnvironmentMonitor.Domain

Contains model / entity classes. Has no project dependencies.

Contains interfaces for common services that are implemented in the Infrastructure project.

### EnvironmentMonitor.Application

"Application layer". Includes AutoMapper and is meant to be used by "driving applications", such as the WebApi / Azure function. 

### EnvironmentMonitor.Infrastructure

Contains the implementation for interfaces declared in the Domain project. Includes "infra"-functionality, such as:

- EF core DB configuration
- Repository implementations
- ASP.NET identity logic.
- DB contexts
  -  Two DB contexts have been implemented. MeasurementDbContext for stuff related to measurements and ApplicationDbContext for stuff related to .NET identity.
 
Services of the infrastructure project shouldn't be directly used but rather used by services in the Application project.

### EnvironmentMonitor.WebApi

WebApi project. Includes the end points for fetching measurement data.

### EnvironmentMonitor.HubObserver

Azure Function project which includes a function for listening to IoT hub. The function listens to messages arriving to the IoT hub, processes them and saves them to a DB.

## Instructions

### Adding migrations

- Open Nuget manager console
- Set ``EnvironmentMonitor.Migrations`` as startup project. Set ``EnvironmentMonitor.Infrastructure`` as default project.
- Type ``Add-Migration {MigrationName} -context {Context}``. Context is either MeasurementDbContext or ApplicationDbContext, depending on where the changes were made.

### Running migrations

Migrations can be run with ``EnvironmentMonitor.Migrations`` project. Store DefaultConnection in user secrets and start the project. A confirmation will be asked before running migrations.

